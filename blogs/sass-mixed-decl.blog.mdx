---
title: "Automating Sass Refactoring: Resolving Mixed Declaration Deprecation Warnings"
date: "2024-09-22"
author: "Vignesh Iyer"
description: "Learn how to automate the refactoring of Sass code to resolve mixed declaration deprecation warnings."
tags: ["Sass", "CSS", "Refactoring", "Automation", "Web Development"]
highlightWords: ["Sass", "CSS", "Refactoring", "Automation", "Web Development"]
coverImageSrc: "/sass-mixed-decl.webp"
---

# Automating Sass Refactoring: Resolving Mixed Declaration Deprecation Warnings

![Cover Image](/sass-mixed-decl.webp)

## Automating Sass Refactoring: Resolving Mixed Declaration Deprecation Warnings

### Introduction

If you’ve been working with Sass, you might have encountered the [deprecation warning](https://sass-lang.com/documentation/breaking-changes/mixed-decls/):

```
DEPRECATION WARNING: Sass's behavior for declarations that appear after nested rules will be changing to match the behavior specified by CSS in an upcoming version. To keep the existing behavior, move the declaration above the nested rule. To opt into the new behavior, wrap the declaration in `& {}`.
```

This warning indicates that Sass will soon align with CSS, requiring declarations to appear in the order they’re written. Previously, Sass moved all declarations to the top, which can cause issues. In this post, I’ll show how to automate refactoring Sass files using a Node.js script.

### Understanding the Problem

In Sass, it’s common to mix CSS properties and nested rules within the same block, like this:

```scss
.example {
  color: red;
  a {
    color: blue;
  }
  font-weight: bold;
  i {
    font-style: italic;
  }
}
```

To maintain current behavior, properties like `font-weight` need to be moved above nested rules or wrapped in an `& {}` block.

### Initial Attempt

I started with a simple Node.js script using the `glob` package to scan `.scss` files and move declarations:

```javascript
const glob = require("glob");
const fs = require("fs");

glob("**/*.scss", (err, files) => {
  files.forEach((filePath) => {
    let content = fs.readFileSync(filePath, "utf8");
    const mixedDeclPattern =
      /([a-zA-Z\-]+:\s?[a-zA-Z0-9\(\)\.\,\s%]+;)\s+([a-zA-Z0-9\.\:\#\s\(\)\,\>\+\~]+?\s*\{)/g;
    content = content.replace(
      mixedDeclPattern,
      (match, decl, nestedRule) => `${decl}
${nestedRule}`
    );
    fs.writeFileSync(filePath, content, "utf8");
    console.log(`Refactored ${filePath}`);
  });
});
```

This worked partially but struggled with complex nested structures and caused formatting issues.

### The Final Solution

After refining the script to handle complex scenarios, I developed a solution that:

1. Recursively scans `.scss` files, excluding `node_modules`.
2. Moves all single declarations above nested blocks while preserving nested structures.
3. Maintains original formatting.

Here’s the final version:

```javascript
const fs = require('fs');
const path = require('path');

function findScssFiles(dir, scssFiles = []) {
  const files = fs.readdirSync(dir);
  files.forEach(file => {
    const fullPath = path.join(dir, file);
    const stat = fs.lstatSync(fullPath);
    if (stat.isDirectory()) {
      if (file !== 'node_modules') findScssFiles(fullPath, scssFiles);
    } else if (fullPath.endsWith('.scss')) {
      scssFiles.push(fullPath);
    }
  });
  return scssFiles;
}

function refactorSassFile(filePath) {
  let content = fs.readFileSync(filePath, 'utf8');
  const rulePattern = /([^{]+)\{([^{}]*?)((?:
|\s)*)((\s*[^{}]*\s*)*)\}/g;
  content = content.replace(rulePattern, (match, selector, declarations, ws, nested) => {
    let cleanedDeclarations = declarations.trim().split(';').map(line => line.trim()).filter(Boolean);
    if (!nested || !nested.includes('{')) return match;
    const finalDeclarations = cleanedDeclarations.length > 0 ? cleanedDeclarations.join(';
  ') + ';
' : '';
    return `${selector} {
  ${finalDeclarations}
  ${nested.trim()}
}`;
  });
  fs.writeFileSync(filePath, content, 'utf8');
  console.log(`Refactored ${filePath}`);
}

const startDir = path.resolve(__dirname);
const scssFiles = findScssFiles(startDir);
scssFiles.forEach(filePath => refactorSassFile(filePath));
```

### Running the Script

1. Save the script as `sass-fix.js` in your project directory.
2. Run the script using Node.js:

```bash
node sass-fix.js
```

This will refactor all `.scss` files in your project, ensuring they comply with the new Sass behavior.

### Conclusion

Automating refactoring with Node.js saves time and reduces errors when adapting to new standards. This script handles complex Sass files and keeps your stylesheets future-proof. If you have similar challenges, feel free to reach out. Happy coding!
